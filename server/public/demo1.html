<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RobotArm</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
    <link rel="stylesheet" href="./mdui_0.3.0/css/mdui.min.css">
    <style>
        .control{
            margin:auto 50px auto 50px;
        }
        .control label{
            margin-bottom: 20px;
        }
    </style>
</head>
<body class="mdui-drawer-body-left mdui-theme-primary-indigo">
    <div class="mdui-drawer" id="drawer">
        <ul class="mdui-list">
        <!--左边弹出菜单-->
            <li class="mdui-subheader">控制</li>
        <li>
            <span>端口 : &nbsp</span>
            <select class="mdui-select" id="item1">
                <option value="COM1">COM1</option>
                <option value="COM2">COM2</option>
                <option value="COM3">COM3</option>
                <option value="COM4" selected>COM4</option>
                <option value="COM5">COM5</option>
                <option value="COM6">COM6</option>
            </select>
        </li>
        <li >
            <span>波特率 : &nbsp</span>
            <select class="mdui-select" id="item2">
                <option value="9600">9600</option>
                <option value="115200">115200</option>
                <option value="3" disabled>State 3</option>
                <option value="4">State 4</option>
                <option value="5">State 5</option>
                <option value="6">State 6</option>
            </select>
        </li>

            <button id="connect" class="mdui-btn mdui-btn-raised mdui-ripple mdui-color-theme-accent">连接</button>




    </ul>
    </div>
    <div class="mdui-toolbar nav_header">
        <!--顶部工具栏-->
        <a id="toggle" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons" id='icon_menu'>arrow_back</i></a>
        <span href="javascript:;" class="mdui-typo-headline">DOUBLE</span>
        <div class="mdui-toolbar-spacer"><span href="javascript:;" class="mdui-typo-title">多平台控制的智能机械臂系统</span></div>
        <a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">refresh</i></a>
        <a href="javascript:;" class="mdui-btn mdui-btn-icon"><i class="mdui-icon material-icons">more_vert</i></a>
    </div>
    <div class="mdui-container-fluid">
        <!-- main-->
        <div>
            <h3 >状态:<span id="status1">未连接</span></h3>
            <p>滑动滑块控制舵机角度</p>
        </div>
        <div class="control" id='servo_control'>
            <span>舵机0: </span>
            <label class="mdui-slider mdui-slider-discrete" id="con0">
                <input id="servo0" type="range" step="1" min="0" max="180"/>
            </label>
            <span>舵机1:</span>
            <label class="mdui-slider mdui-slider-discrete" id="con1">
                <input id="servo1" type="range" step="1" min="0" max="180"/>
            </label>
            <span>舵机2: </span>
            <label class="mdui-slider mdui-slider-discrete" id="con2">
                <input id="servo2" type="range" step="1" min="0" max="180"/>
            </label>
            <span>舵机3: </span>
            <label class="mdui-slider mdui-slider-discrete" id="con3">
                <input id="servo3" type="range" step="1" min="0" max="180"/>
            </label>
            <span>舵机4: </span>
            <label class="mdui-slider mdui-slider-discrete" id="con4">
                <input id="servo4" type="range" step="1" min="0" max="180"/>
            </label>
            <span>舵机5: </span>
            <label class="mdui-slider mdui-slider-discrete" id="con5">
                <input id="servo5" type="range" step="1" min="0" max="180"/>
            </label>
            
        </div>

    </div>
    <footer>
        <!--footer-->
    </footer>


    <script src="./mdui_0.3.0/js/mdui.min.js"></script>
    <script src="./socket.io/socket.io.js"></script>
	
	
	    <script>
             
        var inst = new mdui.Drawer('#drawer');
        var icon_menu = document.getElementById('icon_menu');

        //inst.close();

        document.getElementById('toggle').addEventListener('click', function () {
            inst.toggle();
        });

        // event
        var drawer = document.getElementById('drawer');

        drawer.addEventListener('opened.mdui.drawer', function () {
            icon_menu.innerText = 'arrow_back';
        });

        drawer.addEventListener('closed.mdui.drawer', function () {
            icon_menu.innerText = 'menu';
        });
        var inst1 = new mdui.Select('#item1');
        var inst2 = new mdui.Select('#item2');
        
        var servos=[];
        var a=document.getElementById("servo_control");
        var slider = a.getElementsByTagName('input');
        var connected = false;
     
        var connect_btn = document.getElementById("connect");
        var portName = document.getElementById("item1").value;
        var baudRate = document.getElementById("item2").value;
        var connectStatus = document.getElementById('status1');
       
        
        var init = function(){
        	for(var i=0;i<6;i++){
                servos[i]={
                    number: i,
                    pos: slider[i].value
                };
            };
            
            if(connected){
                connect_btn.setAttribute('disabled',true);
                connectStatus.innerText = '已连接';
            }

        	
        } 
        
    
        
        
        //连接服务器
	  var socket = io.connect('http://localhost:8080');
	  socket.on('server succeed', function (data) {
        console.log(data);
        if(data.status){
            connected = true;
        }
        socket.emit('client succeed', { client: 'succeed' });
        //初始化
        init();

        
	    //发送串口信息
	    connect_btn.addEventListener('click', function () {
            console.log(portName);
            console.log(baudRate);
	    	socket.emit('serialPortConnect',{portName: portName, baudRate: baudRate});
	    });
        //接收串口连接成功的消息
        socket.on('spIsConnected',function(data){
            console.log(data);
            if(data.status = true){
                connected = true;
                connectStatus.innerText = '已连接';
                connect_btn.setAttribute('disabled',true);
            }else{
                connectStatus.innerText = '未连接';
            }
            
            //如果已经连接成功,调整端口选择框，把连接按钮置为不可点击状态
        })

        //监测滑块实时变化，每次滑动都向服务发送舵机角度数据
        for(let i=0;i<6;i++){
            slider[i].onmousedown = function (evt) {
                var that = this;
                document.onmouseup = function (evt) {
                    if(connected){
                        console.log(that.value);
                        window.servos[i].pos = that.value;
                        socket.emit('servosUpdata', servos[i]); 
                        document.onmouseup = null;
                    }else{
                        alert("当前未连接串口！请重试")
                    }
                   
                }
            }
        }
        
	    
	  });
	  
        
    </script>

</body>
</html>